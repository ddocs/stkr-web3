version: 2.1
jobs:
  build:
    docker:
      - image: tarampampam/node:13-alpine
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: '.'
      - run:
          name: "Build the production code"
          command: |
            node --version
            npm --version
            yarn install
            yarn build
      - persist_to_workspace:
          root: '.'
          paths:
            - '.'
  app_deploy_cdn: &app_deploy_cdn
    docker:
      - image: bigbadalien/awscli-node-kops-kubectl:0.3
    steps:
      - setup_remote_docker
      - attach_workspace:
          at: '.'
      - run:
          name: "Uploading assets to strk website"
          command: |
            pwd

            echo "Uploading assets to $DOMAIN"
            aws s3 cp ./dist/ s3://$DOMAIN/ --acl bucket-owner-full-control --recursive --cache-control "public,max-age=600,s-maxage=3600"

            echo "Invalidating CDN network"
            INVALIDATION_ID=`aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths '/*' | jq -r '.Invalidation.Id'`
            echo "Invalidation ID is $INVALIDATION_ID"
            echo "CDN Invalidation request is sent."
  app_deploy_goerli:
    <<: *app_deploy_cdn
  app_deploy_dev:
    <<: *app_deploy_cdn
    
workflows:
  stkr_web3:
    jobs:
      - build:
          context: cicd
      - app_deploy_goerli:
          context:
            - cicd
            - stkr-goerli
          requires:
            - build
          filters: &prod_only
            branches:
              only:
                - master
      - app_deploy_dev:
          context: 
            - cicd
            - stkr-dev
          requires:
            - build
          filters: &dev_only
            branches:
              only:
              - develop