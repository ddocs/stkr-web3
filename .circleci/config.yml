version: 2
jobs:
  build:
    docker:
      - image: tarampampam/node:13-alpine
    steps:
      - checkout
      - setup_remote_docker
      - attach_workspace:
          at: '.'
      - run:
          name: "Build the production code"
          command: |
            node --version
            npm --version
            cd next
            yarn install
            yarn build
      - persist_to_workspace:
          root: '.'
          paths:
            - '.'
  upload:  
    docker:
      - image: bigbadalien/awscli-node-kops-kubectl:0.3
    steps:
      - setup_remote_docker
      - attach_workspace:
          at: '.'
      - run:
          name: "Uploading assets to strk website"
          command: |
            pwd
            # DOMAIN="stkr.ankr.com"
            # DISTRIBUTION_ID="EMPBFTV79PLW8"

            DOMAIN="stkr-dev.ankr.com"
            DISTRIBUTION_ID="E1LG75GWDIK2Z8"

            echo "Uploading assets to $DOMAIN"
            aws s3 cp ./next/build s3://$DOMAIN/ --acl bucket-owner-full-control --recursive --cache-control "public,max-age=600,s-maxage=3600"

            echo "Invalidating CDN network"
            INVALIDATION_ID=`aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths '/*' | jq -r '.Invalidation.Id'`
            echo "Invalidation ID is $INVALIDATION_ID"
            echo "CDN Invalidation request is sent."
workflows:
  version: 2
  stkr_web3:
    jobs:
      - build:
          context: cicd
      - upload:
          context: cicd
          requires:
            - build
          filters: &prod_only
            branches:
              only:
                - FD-2895_stkr